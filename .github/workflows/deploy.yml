# Deployment Workflow
# Deploys to Vultr VPS on push to main

name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

env:
  SERVER_HOST: 158.247.204.45
  SERVER_USER: root
  DEPLOY_PATH: /root/streaming_agent

jobs:
  deploy:
    name: Deploy to Vultr
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VULTR_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            set -e

            echo "ðŸ“¦ Pulling latest code..."
            cd ${{ env.DEPLOY_PATH }}
            git fetch origin main
            git reset --hard origin/main

            echo "ðŸ“¥ Installing server dependencies..."
            cd server
            npm ci --omit=dev
            cd ..

            echo "ðŸ”„ Restarting application..."
            pm2 restart streaming-agent --update-env || pm2 start ecosystem.config.js --env production

            echo "âœ… Deployment completed!"
            pm2 status
          ENDSSH

      - name: Health Check
        run: |
          echo "Waiting for server to start..."
          sleep 10
          curl -f http://${{ env.SERVER_HOST }}:3001/health || echo "Health check endpoint not responding"

  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deployment to Vultr completed successfully"
            echo "ðŸŒ Server: http://${{ env.SERVER_HOST }}:3001"
          else
            echo "âŒ Deployment failed"
          fi

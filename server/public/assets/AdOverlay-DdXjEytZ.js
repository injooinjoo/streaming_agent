import{u as b,r,n as l,s as o,j as d}from"./index-C4j2AckJ.js";const j=1920,I=1080,C=({slot:e,activeAd:s,onImpression:f,onAdClick:p})=>{const c=r.useRef(!1);if(r.useEffect(()=>{s&&!c.current&&(c.current=!0,f(e.id,s.id)),s||(c.current=!1)},[s,e.id,f]),!s)return null;const g={position:"absolute",left:`${e.position.x}%`,top:`${e.position.y}%`,width:`${e.size.width/j*100}%`,height:`${e.size.height/I*100}%`},m=()=>{s.clickUrl&&(p(e.id,s.id),window.open(s.clickUrl,"_blank"))};return d.jsxs("div",{className:`ad-slot ad-type-${s.contentType}`,style:g,onClick:m,children:[s.contentType==="image"&&d.jsx("img",{src:s.contentUrl,alt:s.name||"Advertisement",className:"ad-content-image",draggable:!1}),s.contentType==="video"&&d.jsx("video",{src:s.contentUrl,className:"ad-content-video",autoPlay:!0,muted:!0,loop:!0,playsInline:!0}),s.contentType==="html"&&d.jsx("iframe",{src:s.contentUrl,className:"ad-content-iframe",frameBorder:"0",scrolling:"no",title:s.name||"Advertisement"})]})},w=()=>{const{userHash:e}=b(),[s,f]=r.useState([]),[p,c]=r.useState({}),[g,m]=r.useState(!1);r.useEffect(()=>(document.body.classList.add("overlay-mode"),()=>document.body.classList.remove("overlay-mode")),[]);const h=r.useCallback(async()=>{try{const a=e?`${l}/api/overlay/${e}/ads/slots`:`${l}/api/ads/slots`,t=await fetch(a);if(t.ok){const n=await t.json();f((n.slots||n||[]).filter(i=>i.enabled))}}catch(a){console.error("Failed to fetch ad slots:",a)}},[e]),u=r.useCallback(async()=>{try{const a=e?`${l}/api/overlay/${e}/ads/active`:`${l}/api/ads/active`,t=await fetch(a);if(t.ok){const n=await t.json(),i={};(n.ads||n||[]).forEach(y=>{y.slotId&&(i[y.slotId]=y)}),c(i)}}catch(a){console.error("Failed to fetch active ads:",a)}},[e]),k=r.useCallback(async(a,t)=>{try{await fetch(`${l}/api/ads/impression`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slotId:a,campaignId:t,userHash:e,timestamp:new Date().toISOString()})})}catch(n){console.error("Failed to record impression:",n)}},[e]),S=r.useCallback(async(a,t)=>{try{await fetch(`${l}/api/ads/click`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({slotId:a,campaignId:t,userHash:e,timestamp:new Date().toISOString()})})}catch(n){console.error("Failed to record click:",n)}},[e]);return r.useEffect(()=>{h(),u(),e&&o.emit("join-ad-overlay",e),o.on("connect",()=>m(!0)),o.on("disconnect",()=>m(!1)),o.on("ad-slots-updated",t=>{(!e||t.userHash===e)&&f((t.slots||[]).filter(n=>n.enabled))}),o.on("ad-campaign-start",t=>{(!e||t.userHash===e)&&c(n=>({...n,[t.slotId]:t.ad}))}),o.on("ad-campaign-end",t=>{(!e||t.userHash===e)&&c(n=>{const i={...n};return delete i[t.slotId],i})}),o.on("ads-refresh",()=>{u()}),o.on("settings-updated",t=>{t.key==="ads"&&(h(),u())});const a=setInterval(()=>{u()},3e4);return()=>{e&&o.emit("leave-ad-overlay",e),o.off("connect"),o.off("disconnect"),o.off("ad-slots-updated"),o.off("ad-campaign-start"),o.off("ad-campaign-end"),o.off("ads-refresh"),o.off("settings-updated"),clearInterval(a)}},[e,h,u]),Object.keys(p).length>0,d.jsxs("div",{className:"ad-overlay-container",children:[s.map(a=>d.jsx(C,{slot:a,activeAd:p[a.id],onImpression:k,onAdClick:S},a.id)),!1]})};export{w as default};
